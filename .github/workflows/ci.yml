name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        toolchain: [gcc, clang]
        sanitizer: [none, asan, ubsan, tsan]
        exclude:
          # Prefer clang for TSan (better support, fewer false positives).
          - toolchain: gcc
            sanitizer: tsan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config libgtest-dev
          if [ "${{ matrix.toolchain }}" = "clang" ]; then
            sudo apt-get install -y clang
          else
            sudo apt-get install -y g++
          fi

          # Ubuntu's libgtest-dev may ship sources; build and install the libs so find_package(GTest) works.
          if [ -d /usr/src/gtest ]; then
            cd /usr/src/gtest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          elif [ -d /usr/src/googletest ]; then
            cd /usr/src/googletest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          fi

      - name: Build and run tests
        env:
          CC: ${{ matrix.toolchain == 'clang' && 'clang' || 'gcc' }}
          CXX: ${{ matrix.toolchain == 'clang' && 'clang++' || 'g++' }}
        run: |
          chmod +x ./build.sh
          if [ "${{ matrix.sanitizer }}" = "asan" ]; then
            ./build.sh -c -t --asan
          elif [ "${{ matrix.sanitizer }}" = "ubsan" ]; then
            ./build.sh -c -t --ubsan
          elif [ "${{ matrix.sanitizer }}" = "tsan" ]; then
            ./build.sh -c -t --tsan
          else
            ./build.sh -c -t
          fi

  install-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config g++

      - name: Build and install
        run: |
          chmod +x ./build.sh
          ./build.sh -c -r
          cmake --install build --prefix "$PWD/_install"

      - name: Build consumer with find_package
        run: |
          mkdir -p /tmp/iocoro-consumer
          cat > /tmp/iocoro-consumer/CMakeLists.txt <<'EOF'
          cmake_minimum_required(VERSION 3.15)
          project(iocoro_consumer LANGUAGES CXX)

          set(CMAKE_CXX_STANDARD 20)
          set(CMAKE_CXX_STANDARD_REQUIRED ON)
          set(CMAKE_CXX_EXTENSIONS OFF)

          find_package(iocoro REQUIRED)

          add_executable(consumer main.cpp)
          target_link_libraries(consumer PRIVATE iocoro::iocoro)
          EOF

          cat > /tmp/iocoro-consumer/main.cpp <<'EOF'
          #include <iocoro/iocoro.hpp>
          #include <chrono>

          using namespace std::chrono_literals;

          auto task() -> iocoro::awaitable<void> {
            co_await iocoro::co_sleep(1ms);
          }

          int main() {
            iocoro::io_context ctx;
            iocoro::co_spawn(ctx.get_executor(), task(), iocoro::detached);
            ctx.run();
            return 0;
          }
          EOF

          cmake -S /tmp/iocoro-consumer -B /tmp/iocoro-consumer/build -G Ninja \
            -DCMAKE_PREFIX_PATH="$PWD/_install"
          cmake --build /tmp/iocoro-consumer/build -j
          /tmp/iocoro-consumer/build/consumer

  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config g++ libgtest-dev gcovr python3

          if [ -d /usr/src/gtest ]; then
            cd /usr/src/gtest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          elif [ -d /usr/src/googletest ]; then
            cd /usr/src/googletest
            sudo cmake -S . -B build
            sudo cmake --build build -j
            sudo cmake --install build
          fi

      - name: Build, test, and collect coverage
        run: |
          chmod +x ./scripts/run_coverage.sh
          ./scripts/run_coverage.sh --clean --build-dir build-coverage --jobs "$(nproc)" --min-line 70

      - name: Coverage summary
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          p = Path("build-coverage/coverage/summary.json")
          data = json.loads(p.read_text(encoding="utf-8"))
          line = data.get("line_percent", 0.0)
          branch = data.get("branch_percent", 0.0)
          func = data.get("function_percent", 0.0)
          with open(Path.home() / "coverage_summary.md", "w", encoding="utf-8") as f:
              f.write("## Coverage Metrics\n")
              f.write(f"- Line: **{line:.2f}%**\n")
              f.write(f"- Branch: **{branch:.2f}%**\n")
              f.write(f"- Function: **{func:.2f}%**\n")
          PY
          cat "$HOME/coverage_summary.md" >> "$GITHUB_STEP_SUMMARY"

  perf-regression-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config g++ libboost-dev python3-jsonschema

      - name: Build benchmarks
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DIOCORO_BUILD_BENCHMARKS=ON
          cmake --build build -j

      - name: Run perf baseline gate
        run: |
          ./benchmark/scripts/run_all_perf_benchmarks.sh \
            --build-dir build \
            --iterations 3 \
            --warmup 1 \
            --timeout-sec 180
